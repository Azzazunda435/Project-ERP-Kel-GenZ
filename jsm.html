<!-- jsm.html -->
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ERP - Johnson's Rule (JSM)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/css/styles.css" rel="stylesheet">
</head>
<body>
  <div id="headerInclude"></div>
  <main class="container my-4">
    <h1 class="h4">Johnson's Rule (JSM)</h1>
    <p class="text-muted">Penjadwalan 2–3 mesin untuk meminimalkan makespan (dengan langkah & idle time).</p>

    <div class="mb-3">
      <label for="inputArea" class="form-label">Input Data Job</label>
      <p class="text-muted small">
        Format: satu job per baris, pisahkan dengan koma:<br>
        <code>NamaJob, waktuMesin1, waktuMesin2, waktuMesin3 (opsional)</code><br><br>
        Contoh 3 mesin:<br>
        <code>J1,3,8,5</code><br>
        <code>J2,5,4,6</code><br>
        <code>J3,2,6,7</code><br><br>
        Contoh 2 mesin:<br>
        <code>J1,3,8</code><br>
        <code>J2,5,4</code>
      </p>
      <textarea id="inputArea" class="form-control" rows="6" aria-label="Input area" placeholder="J1,3,8,5&#10;J2,5,4,6&#10;J3,2,6,7">J1,3,8,5
J2,5,4,6
J3,2,6,7</textarea>
      <div class="form-text input-error text-danger"></div>
    </div>

    <div class="mb-3">
      <button id="btnCalc" class="btn btn-primary">Hitung Urutan &amp; Makespan</button>
      <button id="btnReset" class="btn btn-secondary">Reset</button>
      <button id="btnCSV" class="btn btn-outline-success">Export CSV</button>
      <a href="index.html" class="btn btn-link">Kembali ke Dashboard</a>
    </div>

    <div id="loading" style="display:none;" class="mb-3"><div class="spinner-border" role="status"><span class="visually-hidden">Memuat...</span></div> Memproses...</div>

    <section id="resultSection" aria-live="polite" style="display:none;">
      <div id="result" class="mt-4"></div>
      <div class="mt-4">
        <h5 class="mt-3">Chart</h5>
        <canvas id="chartArea" height="100"></canvas>
      </div>
    </section>
  </main>
  <div id="footerInclude"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/app.js"></script>
  <script>
  // include header/footer
  ['header.html','footer.html'].forEach(function(file){
    fetch(file).then(function(r){return r.text();}).then(function(t){
      if(file==='header.html') document.getElementById('headerInclude').innerHTML = t;
      else document.getElementById('footerInclude').innerHTML = t;
    });
  });

  const inputArea = document.getElementById('inputArea');
  const btnCalc = document.getElementById('btnCalc');
  const btnReset = document.getElementById('btnReset');
  const btnCSV = document.getElementById('btnCSV');
  const loading = document.getElementById('loading');
  const resultSection = document.getElementById('resultSection');
  const resultDiv = document.getElementById('result');
  const chartCtx = document.getElementById('chartArea').getContext('2d');
  let pageChart = null;

  // Parse teks input jadi array job
  function parseJobs(raw) {
    var lines = raw.split('\n');
    var jobs = [];
    var machineCount = null;

    for (var i = 0; i < lines.length; i++) {
      var line = lines[i].trim();
      if (!line) continue;

      var parts = line.split(',');
      for (var j = 0; j < parts.length; j++) {
        parts[j] = parts[j].trim();
      }

      if (parts.length < 3) continue; // minimal: Nama, M1, M2

      if (machineCount === null) {
        machineCount = parts.length - 1;
        if (machineCount !== 2 && machineCount !== 3) {
          throw new Error('Jumlah mesin per job harus 2 atau 3.');
        }
      } else {
        if (parts.length - 1 !== machineCount) {
          throw new Error('Semua baris harus memiliki jumlah waktu mesin yang sama (2 atau 3).');
        }
      }

      var name = parts[0];
      var times = [];
      for (var k = 1; k <= machineCount; k++) {
        var t = parseFloat(parts[k]);
        if (isNaN(t)) {
          throw new Error('Waktu proses mesin harus berupa angka.');
        }
        times.push(t);
      }

      jobs.push({ name: name, times: times });
    }

    if (jobs.length === 0) {
      throw new Error('Tidak ada data job yang valid.');
    }

    return { jobs: jobs, machineCount: machineCount };
  }

  // Buat mesin semu A & B
  function makePseudoJobs(jobs, machineCount) {
    var pseudo = [];
    for (var i = 0; i < jobs.length; i++) {
      var job = jobs[i];
      var A, B;
      if (machineCount === 2) {
        A = job.times[0];
        B = job.times[1];
      } else {
        A = job.times[0] + job.times[1]; // M1 + M2
        B = job.times[1] + job.times[2]; // M2 + M3
      }
      pseudo.push({
        name: job.name,
        times: job.times.slice(),
        A: A,
        B: B
      });
    }
    return pseudo;
  }

  // Johnson sequence (pakai mesin semu)
  function johnsonSequence(pseudoJobs) {
    var remaining = pseudoJobs.slice();
    var n = remaining.length;
    var seq = new Array(n);
    var left = 0;
    var right = n - 1;
    var steps = [];
    var stepNum = 1;

    while (remaining.length > 0) {
      var minTime = Infinity;
      var minIndex = -1;
      var fromMachine = 'A';

      for (var i = 0; i < remaining.length; i++) {
        var job = remaining[i];
        if (job.A < minTime) {
          minTime = job.A;
          minIndex = i;
          fromMachine = 'A';
        }
        if (job.B < minTime) {
          minTime = job.B;
          minIndex = i;
          fromMachine = 'B';
        }
      }

      var chosen = remaining[minIndex];
      var positionText;
      if (fromMachine === 'A') {
        seq[left] = chosen;
        positionText = 'Depan (posisi ' + (left + 1) + ')';
        left++;
      } else {
        seq[right] = chosen;
        positionText = 'Belakang (posisi ' + (right + 1) + ')';
        right--;
      }

      steps.push({
        step: stepNum,
        jobName: chosen.name,
        value: minTime,
        fromMachine: fromMachine,
        position: positionText
      });
      stepNum++;

      remaining.splice(minIndex, 1);
    }

    return { sequence: seq, steps: steps };
  }

  // Hitung jadwal & makespan + langkah waktu
  function hitungJadwal(sequence, machineCount) {
    // completion[m] = waktu selesai terakhir di mesin m
    var completion = [];
    for (var i = 0; i < machineCount; i++) {
      completion.push(0);
    }

    var timeline = [];
    var detailSteps = [];

    for (var j = 0; j < sequence.length; j++) {
      var job = sequence[j];
      var startTimes = [];
      var finishTimes = [];

      for (var m = 0; m < machineCount; m++) {
        var start, finish, text;

        if (m === 0) {
          // Mesin pertama: lanjut dari waktu selesai job sebelumnya di M1
          var prevSame = completion[m];
          start = prevSame;
          finish = start + job.times[m];

          text = 'Job ' + job.name + ' di M1: waktu mulai = ' + start +
                 ' (lanjutan dari waktu selesai job sebelumnya di M1), ' +
                 'waktu selesai = ' + start + ' + ' + job.times[m] +
                 ' = ' + finish + '.';
        } else {
          // Mesin ke-2 atau ke-3:
          // start = max( selesai job sebelumnya di mesin ini, selesai job ini di mesin sebelumnya )
          var prevSameMachine = completion[m];
          var prevMachineFinish = finishTimes[m - 1];

          start = prevSameMachine > prevMachineFinish
            ? prevSameMachine
            : prevMachineFinish;

          finish = start + job.times[m];

          text = 'Job ' + job.name + ' di M' + (m + 1) +
                 ': waktu mulai = max(selesai job sebelumnya di M' + (m + 1) +
                 ' = ' + prevSameMachine + ', selesai job ini di M' + m +
                 ' = ' + prevMachineFinish + ') = ' + start +
                 '; waktu selesai = ' + start + ' + ' + job.times[m] +
                 ' = ' + finish + '.';
        }

        completion[m] = finish;
        startTimes.push(start);
        finishTimes.push(finish);
        detailSteps.push(text);
      }

      timeline.push({
        name: job.name,
        start: startTimes,
        completion: finishTimes
      });
    }

    return {
      timeline: timeline,
      makespan: completion[machineCount - 1],
      detailSteps: detailSteps
    };
  }

  function hitungJohnson() {
    var raw = inputArea.value.trim();
    if (!raw) {
      alert('Masukkan data job terlebih dahulu.');
      return;
    }

    var parsed;
    try {
      parsed = parseJobs(raw);
    } catch (e) {
      alert(e.message);
      return;
    }

    var jobs = parsed.jobs;
    var machineCount = parsed.machineCount;

    var pseudoJobs = makePseudoJobs(jobs, machineCount);
    var johnsonRes = johnsonSequence(pseudoJobs);
    var sequence = johnsonRes.sequence;
    var steps = johnsonRes.steps;

    var jadwal = hitungJadwal(sequence, machineCount);
    var timeline = jadwal.timeline;
    var makespan = jadwal.makespan;
    var detailSteps = jadwal.detailSteps;

    // ====== BUILD REPORT HTML ======

    // 1. Tabel data waktu proses
    var inputTable = '<h3>1. Data Waktu Proses per Job</h3>';
    inputTable += '<table class="table table-bordered table-striped"><thead><tr><th>Job</th>';
    for (var m = 0; m < machineCount; m++) {
      inputTable += '<th>M' + (m + 1) + '</th>';
    }
    inputTable += '</tr></thead><tbody>';

    for (var i = 0; i < jobs.length; i++) {
      inputTable += '<tr><td>' + jobs[i].name + '</td>';
      for (var k = 0; k < machineCount; k++) {
        inputTable += '<td>' + jobs[i].times[k] + '</td>';
      }
      inputTable += '</tr>';
    }
    inputTable += '</tbody></table>';

    // 2. Tabel mesin semu A dan B
    var pseudoTable = '<h3>2. Mesin Semu untuk Johnson</h3>';
    pseudoTable += '<p>';
    if (machineCount === 3) {
      pseudoTable += 'Untuk 3 mesin digunakan dua mesin semu: A = M1 + M2, B = M2 + M3.';
    } else {
      pseudoTable += 'Untuk 2 mesin, A = M1 dan B = M2 (Johnson klasik).';
    }
    pseudoTable += '</p>';

    pseudoTable += '<table class="table table-bordered table-striped"><thead><tr><th>Job</th><th>A</th><th>B</th></tr></thead><tbody>';
    for (var p = 0; p < pseudoJobs.length; p++) {
      pseudoTable += '<tr><td>' + pseudoJobs[p].name + '</td>' +
                     '<td>' + pseudoJobs[p].A + '</td>' +
                     '<td>' + pseudoJobs[p].B + '</td></tr>';
    }
    pseudoTable += '</tbody></table>';

    // 3. Tabel langkah Johnson
    var stepTable = '<h3>3. Langkah Penerapan Johnson\'s Rule</h3>';
    stepTable += '<table class="table table-bordered table-striped"><thead><tr><th>Langkah</th><th>Job dipilih</th><th>Nilai minimum</th><th>Dari mesin</th><th>Ditempatkan di</th></tr></thead><tbody>';
    for (var s = 0; s < steps.length; s++) {
      stepTable += '<tr>' +
        '<td>' + steps[s].step + '</td>' +
        '<td>' + steps[s].jobName + '</td>' +
        '<td>' + steps[s].value + '</td>' +
        '<td>' + steps[s].fromMachine + '</td>' +
        '<td>' + steps[s].position + '</td>' +
        '</tr>';
    }
    stepTable += '</tbody></table>';

    // 4. Urutan job optimal
    var orderText = '';
    for (var u = 0; u < sequence.length; u++) {
      orderText += sequence[u].name;
      if (u !== sequence.length - 1) {
        orderText += ' ➜ ';
      }
    }
    var orderHtml = '<h3>4. Urutan Job Optimal</h3><p class="alert alert-success"><strong>' + orderText + '</strong></p>';

    // 5. Jadwal dan completion time
    var scheduleTable = '<h3>5. Jadwal Produksi dan Waktu Selesai Tiap Mesin</h3>';
    scheduleTable += '<table class="table table-bordered table-striped"><thead><tr><th>Job</th>';
    for (var mm = 0; mm < machineCount; mm++) {
      scheduleTable += '<th>Selesai M' + (mm + 1) + '</th>';
    }
    scheduleTable += '</tr></thead><tbody>';

    for (var t = 0; t < timeline.length; t++) {
      scheduleTable += '<tr><td>' + timeline[t].name + '</td>';
      for (var cm = 0; cm < machineCount; cm++) {
        scheduleTable += '<td>' + timeline[t].completion[cm] + '</td>';
      }
      scheduleTable += '</tr>';
    }
    scheduleTable += '</tbody></table>';

    // 6. Langkah perhitungan waktu mulai & selesai
    var langkahWaktuHtml = '<h3>6. Langkah Perhitungan Waktu Mulai &amp; Selesai</h3>';
    langkahWaktuHtml += '<p>Rumus umum untuk setiap operasi (job ke-i pada mesin ke-j):<br>' +
      '<em>Start(i,j) = max( C(i-1,j), C(i,j-1) )</em> untuk j &gt; 1<br>' +
      '<em>Start(i,1) = C(i-1,1)</em> untuk mesin pertama<br>' +
      '<em>Finish(i,j) = Start(i,j) + p(i,j)</em>, dengan p(i,j) = waktu proses job i di mesin j.</p>';

    langkahWaktuHtml += '<ol>';
    for (var ls = 0; ls < detailSteps.length; ls++) {
      langkahWaktuHtml += '<li>' + detailSteps[ls] + '</li>';
    }
    langkahWaktuHtml += '</ol>';

    // 7. Idle time per mesin
    // Total waktu proses tiap mesin
    var totalProc = [];
    for (var i2 = 0; i2 < machineCount; i2++) {
      totalProc.push(0);
    }

    for (var j2 = 0; j2 < jobs.length; j2++) {
      for (var m2 = 0; m2 < machineCount; m2++) {
        totalProc[m2] += jobs[j2].times[m2];
      }
    }

    var idleTable = '<h3>7. Waktu Menganggur (Idle Time) Tiap Mesin</h3>';
    idleTable += '<p>Idle time dihitung dengan rumus:<br>' +
                 '<em>Idle Time Mesin m = Makespan - Σ waktu proses Mesin m</em><br>' +
                 'dengan rentang waktu dari 0 sampai makespan pada mesin terakhir.</p>';

    idleTable += '<table class="table table-bordered table-striped"><thead><tr><th>Mesin</th><th>Σ Waktu Proses</th><th>Makespan</th><th>Idle Time</th></tr></thead><tbody>';

    for (var m3 = 0; m3 < machineCount; m3++) {
      var idle = makespan - totalProc[m3];
      idleTable += '<tr>' +
        '<td>M' + (m3 + 1) + '</td>' +
        '<td>' + totalProc[m3] + '</td>' +
        '<td>' + makespan + '</td>' +
        '<td>' + idle + '</td>' +
        '</tr>';
    }
    idleTable += '</tbody></table>';

    var kesimpulan =
      '<p class="alert alert-info"><strong>Laporan / Kesimpulan:</strong><br>' +
      'Dengan menggunakan Johnson\'s Rule pada ' + jobs.length +
      ' job dan ' + machineCount + ' mesin, diperoleh urutan seperti di atas ' +
      'dengan nilai makespan (waktu selesai pada mesin terakhir) sebesar ' +
      '<strong>' + makespan + '</strong> satuan waktu. ' +
      'Tabel idle time menunjukkan berapa lama setiap mesin menganggur dalam rentang 0 hingga makespan.</p>';

    var fullReport = '<h2>Hasil Johnson\'s Rule</h2>' +
                     inputTable +
                     pseudoTable +
                     stepTable +
                     orderHtml +
                     scheduleTable +
                     langkahWaktuHtml +
                     idleTable +
                     kesimpulan;

    resultDiv.innerHTML = fullReport;
    resultSection.style.display = 'block';

    // ====== GRAFIK ======
    var labels = [];
    var lastComp = [];
    for (var g = 0; g < timeline.length; g++) {
      labels.push(timeline[g].name);
      lastComp.push(timeline[g].completion[machineCount - 1]);
    }

    if (pageChart) {
      pageChart.destroy();
    }
    pageChart = new Chart(chartCtx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Waktu selesai mesin terakhir',
          data: lastComp,
          backgroundColor: 'rgba(54, 162, 235, 0.5)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  btnCalc.addEventListener('click', function(){
    APP.clearError(inputArea);
    loading.style.display='inline-block';
    setTimeout(function(){
      loading.style.display='none';
      try {
        hitungJohnson();
      } catch(e) {
        APP.showError(inputArea, e.message);
      }
    }, 300);
  });

  btnReset.addEventListener('click', function(){
    inputArea.value = `J1,3,8,5
J2,5,4,6
J3,2,6,7`;
    resultDiv.innerHTML = '';
    resultSection.style.display = 'none';
    if(pageChart){ pageChart.destroy(); pageChart=null; }
    APP.clearError(inputArea);
  });

  btnCSV.addEventListener('click', function(){
    var tables = resultDiv.querySelectorAll('table');
    if(!tables.length){ alert('Tidak ada tabel untuk diexport'); return; }
    
    var allRows = [];
    tables.forEach(function(table, idx){
      if(idx > 0) allRows.push([]); // separator
      var rows = Array.from(table.querySelectorAll('tr')).map(function(tr){ 
        return Array.from(tr.querySelectorAll('th,td')).map(function(td){ 
          return td.textContent; 
        }); 
      });
      allRows = allRows.concat(rows);
    });
    
    APP.exportCSV("johnson_rule_result.csv", allRows);
  });
  </script>
</body>
</html>
