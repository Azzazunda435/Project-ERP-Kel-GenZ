<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ERP - Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="assets/css/styles.css" rel="stylesheet">
</head>
<body>
  <div id="headerInclude"></div>
  <main class="container my-4" role="main">
    <section class="app-hero fade-in p-3">
      <div>
        <h1 class="h3 mb-1">Halo, Admin</h1>
        <p class="helper mb-0">Ringkasan kinerja & aktivitas â€” cepat lihat metrik penting.</p>
        <div class="d-flex align-items-center gap-2 mt-2">
          <!-- Periode selector removed as requested -->
        </div>
      </div>
      <div class="stats-grid">
        <div class="stat-card card-glass">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon bg-light rounded-circle p-2"><i class="bi bi-receipt-cutoff fs-4 text-primary"></i></div>
            <div>
              <div class="helper">Jumlah Transaksi</div>
                <div class="d-flex align-items-baseline gap-2">
                  <div class="h4 mb-0">
                    <span id="numTxValue">120</span>
                    <div class="helper small" id="numTxUnit">transaksi</div>
                  </div>
                  <div id="numTxTrend" class="helper mt-1"></div>
                </div>
            </div>
          </div>
        </div>
        <div class="stat-card card-glass">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon bg-light rounded-circle p-2"><i class="bi bi-people-fill fs-4 text-primary"></i></div>
            <div>
              <div class="helper">Pengguna Aktif</div>
              <div class="d-flex align-items-baseline gap-2">
                <div class="h4 mb-0">
                  <span id="userCountValue">5</span>
                  <div class="helper small" id="userCountUnit">pengguna</div>
                </div>
              </div>
              <div id="userTrend" class="helper mt-1"></div>
            </div>
          </div>
        </div>
        <div class="stat-card card-glass">
          <div class="d-flex align-items-center gap-3">
            <div class="stat-icon bg-light rounded-circle p-2"><i class="bi bi-wallet2 fs-4 text-primary"></i></div>
            <div>
              <div class="helper">Pendapatan Bulanan</div>
              <div class="d-flex align-items-baseline gap-2">
                <div class="h4 mb-0">
                  <span id="revenueValue">12.450.000</span>
                  <div class="helper small" id="revenueUnit">Rp</div>
                </div>
              </div>
              <div id="revenueTrend" class="helper mt-1"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="row g-3 mt-3">
      <div class="col-lg-8">
        <div class="card-glass chart-wrap">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="d-flex align-items-center gap-3">
              <h5 class="mb-0">Ringkasan Penjualan</h5>
              <span class="badge-accent">Realtime</span>
            </div>
            <div class="d-flex align-items-center">
              <label for="chartSelect" class="form-label mb-0 me-2">Pilih:</label>
              <select id="chartSelect" class="form-select form-select-sm w-auto" aria-label="Pilih data chart">
                <option value="sales">Penjualan Bulanan</option>
                <option value="freq">Frekuensi Item</option>
                <option value="forecast">Hasil Forecasting Terakhir</option>
              </select>
            </div>
          </div>
          <canvas id="mainChart" height="140" aria-label="Chart ringkasan"></canvas>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card-glass">
          <h6>Shortcut</h6>
          <div class="quick-actions mt-2">
            <a href="bom.html" class="action-card"> <i class="bi bi-box-seam"></i> BOM</a>
            <a href="forecasting.html" class="action-card"> <i class="bi bi-bar-chart-line-fill"></i> Forecast</a>
            <a href="jsm.html" class="action-card"> <i class="bi bi-lightning-fill"></i> JSM</a>
            <a href="market-basket.html" class="action-card"> <i class="bi bi-basket-fill"></i> Market Basket</a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="footerInclude"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/app.js"></script>
  <script>
  // include header/footer
  ['header.html','footer.html'].forEach(function(file){
    fetch(file).then(function(r){return r.text();}).then(function(t){
      if(file==='header.html') document.getElementById('headerInclude').innerHTML = t;
      else document.getElementById('footerInclude').innerHTML = t;
    });
  });

  // Dashboard chart
  const ctx = document.getElementById('mainChart').getContext('2d');
  const sample = {
    sales: {labels:['Jan','Feb','Mar','Apr','Mei','Jun'], data:[120,130,125,140,150,160]},
    freq: {labels:['Komp1','Komp2','Komp3'], data:[40,60,20]},
    forecast: {labels:['P1','P2','P3','P4'], data:[125,130,132,128]}
  };
  function prepareDataset(set,label){
    const raw = (set.data || []).map(v=>Number(v)||0);
    const maxVal = raw.reduce((m,v)=> v>m? v:m, 0);
    // choose replacement for zeros: make placeholder bars clearly visible
    // use 25% of max (or at least 4) so Jul-Des placeholders are not too short
    const fill = maxVal > 0 ? Math.max(Math.round(maxVal * 0.25), 4) : 4;
    const adj = raw.map(v => (v === 0 ? fill : v));
    const bg = raw.map(v => v === 0 ? 'rgba(77,168,255,0.18)' : 'rgba(77,168,255,0.45)');
    const bd = raw.map(v => v === 0 ? 'rgba(45,105,180,0.9)' : 'rgba(77,168,255,0.9)');

    // If this is the monthly sales view, limit to Jan..Jun (index 0..5)
    if(label === 'sales'){
      const outLabels = (set.labels || []).slice(0,6);
      const outData = adj.slice(0,6);
      const outBg = bg.slice(0,6);
      const outBd = bd.slice(0,6);
      return { labels: outLabels, dataset: { label: 'Penjualan', data: outData, backgroundColor: outBg, borderColor: outBd, borderWidth: 1, minBarLength: 20, borderRadius: 6 } };
    }

    return { labels: set.labels, dataset: { label: label, data: adj, backgroundColor: bg, borderColor: bd, borderWidth: 1, minBarLength: 20, borderRadius: 6 } };
  }

  var initial = prepareDataset(sample.sales, 'sales');
  var chart = APP.renderChart(ctx,'bar', initial.labels, [initial.dataset]);
  document.getElementById('chartSelect').addEventListener('change', function(e){
    var v = e.target.value;
    var set = sample[v];
    // micro-spinner effect
    var spinner = document.createElement('div');
    spinner.className = 'spinner-border spinner-border-sm ms-2';
    e.target.parentElement.appendChild(spinner);
    setTimeout(function(){
      spinner.remove();
      var pd = prepareDataset(set, v);
      APP.renderChart(ctx,'bar', pd.labels, [pd.dataset], chart);
    }, 500);
  });

  // Period selector: show human-friendly period text
  (function(){
    const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
    const pad = (n)=> n<10? '0'+n : n;
    function formatDate(d){ return pad(d.getDate()) + ' ' + months[d.getMonth()] + ' ' + d.getFullYear(); }
    function weekRange(d){ // ISO-like week Mon..Sun
      const day = d.getDay(); // 0 Sun
      const monday = new Date(d);
      monday.setDate(d.getDate() - ((day + 6) % 7));
      const sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
      return formatDate(monday) + ' - ' + formatDate(sunday);
    }
    const periodSelect = document.getElementById('periodSelect');
    const periodText = document.getElementById('periodText');
    function updatePeriod(v){
      const now = new Date();
      if(v === 'today') periodText.textContent = 'Periode: ' + formatDate(now);
      else if(v === 'week') periodText.textContent = 'Periode: ' + weekRange(now);
      else if(v === 'month') periodText.textContent = 'Periode: ' + months[now.getMonth()] + ' ' + now.getFullYear();
      else periodText.textContent = 'Periode: ' + months[now.getMonth()] + ' ' + now.getFullYear();
    }
    function formatCurr(n){ try{ return 'Rp ' + Number(n).toLocaleString('id-ID'); }catch(e){ return n; } }

    function safeGet(arr, idx){ if(!arr || !Array.isArray(arr)) return 0; return (arr[idx] !== undefined && arr[idx] !== null) ? Number(arr[idx]) : 0; }

    function computeMetrics(period){
      const now = new Date();
      const monthIdx = now.getMonth();
      const year = now.getFullYear();
      const daysInMonth = new Date(year, monthIdx+1, 0).getDate();
      const prevMonthIdx = monthIdx - 1;
      const prevDays = prevMonthIdx >= 0 ? new Date(year, prevMonthIdx+1, 0).getDate() : 30;

      const curMonthSales = safeGet(sample.sales.data, monthIdx);
      const prevMonthSales = safeGet(sample.sales.data, prevMonthIdx);
      const curMonthUsers = safeGet(sample.users.data, monthIdx);
      const prevMonthUsers = safeGet(sample.users.data, prevMonthIdx);
      const curMonthRevenue = safeGet(sample.revenue.data, monthIdx);
      const prevMonthRevenue = safeGet(sample.revenue.data, prevMonthIdx);

      // fallback: if current month datapoint is 0 (sample placeholders), try nearest previous non-zero
      function findLastNonZero(arr, idx){
        if(!Array.isArray(arr)) return 0;
        for(let i = idx; i >= 0; i--){
          const v = Number(arr[i]) || 0;
          if(v !== 0) return v;
        }
        // if none found, try forward search
        for(let i = idx+1; i < arr.length; i++){
          const v = Number(arr[i]) || 0;
          if(v !== 0) return v;
        }
        return 0;
      }

      let cur = { numTx:0, users:0, revenue:0, revenueDisplay:'' };
      let prev = { numTx:0, users:0, revenue:0 };

      if(period === 'today'){
        cur.numTx = Math.round(curMonthSales / daysInMonth);
        prev.numTx = Math.round(prevMonthSales / (prevMonthIdx>=0?prevDays:daysInMonth));
        cur.users = Math.round(curMonthUsers / daysInMonth);
        prev.users = Math.round(prevMonthUsers / (prevMonthIdx>=0?prevDays:daysInMonth));
        cur.revenue = Math.round(curMonthRevenue / daysInMonth);
        prev.revenue = Math.round(prevMonthRevenue / (prevMonthIdx>=0?prevDays:daysInMonth));
      } else if(period === 'week'){
        cur.numTx = Math.round(curMonthSales / 4);
        prev.numTx = Math.round(prevMonthSales / 4);
        cur.users = Math.round(curMonthUsers / 4);
        prev.users = Math.round(prevMonthUsers / 4);
        cur.revenue = Math.round(curMonthRevenue / 4);
        prev.revenue = Math.round(prevMonthRevenue / 4);
      } else { // month
        cur.numTx = Math.round(curMonthSales);
        prev.numTx = Math.round(prevMonthSales);
        cur.users = Math.round(curMonthUsers);
        prev.users = Math.round(prevMonthUsers);
        cur.revenue = Math.round(curMonthRevenue);
        prev.revenue = Math.round(prevMonthRevenue);
      }
      cur.revenueDisplay = formatCurr(cur.revenue);
      return { cur, prev };
    }

    // parsed CSV storage (date-indexed)
    window.__PARSED_DATA = window.__PARSED_DATA || null;

    function parseCSVText(text){
      // expected columns: date(YYYY-MM-DD), transactions, users, revenue
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const rows = [];
      for(let i=0;i<lines.length;i++){
        const parts = lines[i].split(',').map(p=>p.trim());
        if(parts.length < 4) continue;
        const d = parts[0];
        const tx = Number(parts[1]) || 0;
        const users = Number(parts[2]) || 0;
        const rev = Number(parts[3]) || 0;
        rows.push({date:d, tx, users, rev});
      }
      // aggregate
      const byDate = {};
      for(const r of rows){
        byDate[r.date] = byDate[r.date] || {tx:0, users:0, rev:0};
        byDate[r.date].tx += r.tx;
        byDate[r.date].users += r.users;
        byDate[r.date].rev += r.rev;
      }
      window.__PARSED_DATA = { rows, byDate };
      return window.__PARSED_DATA;
    }

    // helper to sum by date range inclusive (date strings)
    function sumRange(startDate, endDate, field){
      if(!window.__PARSED_DATA) return 0;
      const byDate = window.__PARSED_DATA.byDate;
      const s = new Date(startDate), e = new Date(endDate);
      let total = 0;
      for(const d in byDate){
        const dt = new Date(d);
        if(dt >= s && dt <= e) total += Number(byDate[d][field]) || 0;
      }
      return total;
    }

    if(periodSelect && periodText){
      updatePeriod(periodSelect.value);
      function applyMetrics(){
        let metrics = computeMetrics(periodSelect.value);
        // if CSV uploaded, override computeMetrics with precise aggregations
        if(window.__PARSED_DATA){
          const now = new Date();
          if(periodSelect.value === 'today'){
            const today = now.toISOString().slice(0,10);
            const yesterday = new Date(now); yesterday.setDate(now.getDate()-1);
            const ystr = yesterday.toISOString().slice(0,10);
            metrics.cur.numTx = sumRange(today,today,'tx');
            metrics.prev.numTx = sumRange(ystr,ystr,'tx');
            metrics.cur.users = sumRange(today,today,'users');
            metrics.prev.users = sumRange(ystr,ystr,'users');
            metrics.cur.revenue = sumRange(today,today,'rev');
            metrics.prev.revenue = sumRange(ystr,ystr,'rev');
            metrics.cur.revenueDisplay = formatCurr(metrics.cur.revenue);
          } else if(periodSelect.value === 'week'){
            const day = now.getDay();
            const monday = new Date(now); monday.setDate(now.getDate() - ((day + 6) % 7));
            const sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
            const prevSunday = new Date(monday); prevSunday.setDate(monday.getDate()-1);
            const prevMonday = new Date(prevSunday); prevMonday.setDate(prevSunday.getDate()-6);
            const a = monday.toISOString().slice(0,10), b = sunday.toISOString().slice(0,10);
            const pa = prevMonday.toISOString().slice(0,10), pb = prevSunday.toISOString().slice(0,10);
            metrics.cur.numTx = sumRange(a,b,'tx');
            metrics.prev.numTx = sumRange(pa,pb,'tx');
            metrics.cur.users = sumRange(a,b,'users');
            metrics.prev.users = sumRange(pa,pb,'users');
            metrics.cur.revenue = sumRange(a,b,'rev');
            metrics.prev.revenue = sumRange(pa,pb,'rev');
            metrics.cur.revenueDisplay = formatCurr(metrics.cur.revenue);
          } else { // month
            const monthIdx = now.getMonth(); const year = now.getFullYear();
            const start = new Date(year, monthIdx, 1); const end = new Date(year, monthIdx+1, 0);
            const prevStart = new Date(year, monthIdx-1, 1); const prevEnd = new Date(year, monthIdx, 0);
            const a = start.toISOString().slice(0,10), b = end.toISOString().slice(0,10);
            const pa = prevStart.toISOString().slice(0,10), pb = prevEnd.toISOString().slice(0,10);
            metrics.cur.numTx = sumRange(a,b,'tx');
            metrics.prev.numTx = sumRange(pa,pb,'tx');
            metrics.cur.users = sumRange(a,b,'users');
            metrics.prev.users = sumRange(pa,pb,'users');
            metrics.cur.revenue = sumRange(a,b,'rev');
            metrics.prev.revenue = sumRange(pa,pb,'rev');
            metrics.cur.revenueDisplay = formatCurr(metrics.cur.revenue);
          }
        }
        const elNum = document.getElementById('numTxValue');
        const elUsers = document.getElementById('userCountValue');
        const elRev = document.getElementById('revenueValue');
        const elRevUnit = document.getElementById('revenueUnit');
        // If samples are placeholders (zeros) and no CSV provided, fallback to nearest non-zero sample
        if(!window.__PARSED_DATA){
          if(!metrics.cur.numTx || metrics.cur.numTx === 0) metrics.cur.numTx = findLastNonZero(sample.sales.data, new Date().getMonth());
          if(!metrics.cur.users || metrics.cur.users === 0) metrics.cur.users = findLastNonZero(sample.users.data, new Date().getMonth());
          if(!metrics.cur.revenue || metrics.cur.revenue === 0) metrics.cur.revenue = findLastNonZero(sample.revenue.data, new Date().getMonth());
          metrics.cur.revenueDisplay = (metrics.cur.revenue ? ('Rp ' + Number(metrics.cur.revenue).toLocaleString('id-ID')) : 'Rp 0');
        }

        if(elNum) { elNum.textContent = String(metrics.cur.numTx); APP.animateNumber(elNum, metrics.cur.numTx, 700); }
        if(elUsers) { elUsers.textContent = String(metrics.cur.users); APP.animateNumber(elUsers, metrics.cur.users, 700); }
        if(elRev) {
          // use animator so thousand-separators appear smoothly
          APP.animateNumber(elRev, metrics.cur.revenue || 0, 900);
          if(elRevUnit) elRevUnit.textContent = 'Rp';
        }
        if(window.APP && typeof APP.updateStats === 'function') APP.updateStats(metrics.prev);
      }
      applyMetrics();
      periodSelect.addEventListener('change', function(){ updatePeriod(this.value); applyMetrics(); });

      // CSV upload handler
      const csvUpload = document.getElementById('csvUpload');
      if(csvUpload){
        csvUpload.addEventListener('change', function(e){
          const f = this.files && this.files[0];
          if(!f) return;
          const reader = new FileReader();
          reader.onload = function(ev){
            try{
              parseCSVText(String(ev.target.result || ''));
              applyMetrics();
              alert('CSV berhasil di-upload dan data terpakai untuk metrik.');
            }catch(err){ alert('Gagal memproses CSV: '+err.message); }
          };
          reader.readAsText(f,'utf-8');
        });
      }
    }
  })();
  </script>
</body>
</html>
