<!-- bom.html -->
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ERP - Bill of Material (BOM)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/css/styles.css" rel="stylesheet">
  <style>
    /* CSS khusus BOM Tree */
    .bom-tree {
      margin-top: 16px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }

    .bom-tree-branch {
      text-align: center;
      position: relative;
      padding-bottom: 18px;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
    }

    .bom-node {
      position: relative;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.96);
      border: 1px solid rgb(0, 0, 0);
      box-shadow: 0 14px 30px rgba(8, 72, 223, 0.9);
      font-size: 0.86rem;
      min-width: 120px;
    }

    .bom-node-root {
      background: radial-gradient(circle at 30% 0, rgba(56, 189, 248, 0.35), rgba(255, 255, 255, 0.96));
      border-color: rgba(56, 189, 248, 0.8);
      margin-bottom: 6px;
    }

    .bom-node-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .bom-node-qty {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    .bom-tree-children {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 14px;
      position: relative;
      padding-top: 16px;
    }

    .bom-tree-children::before {
      content: "";
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 14px;
      background: rgba(148, 163, 184, 0.7);
    }

    .bom-tree-branch .bom-node::before {
      content: "";
      position: absolute;
      top: -12px;
      width: 1px;
      height: 12px;
      background: rgba(255, 255, 255, 0.7);
    }

    .bom-node-root::before {
      content: none;
    }

    @media (max-width: 640px) {
      .bom-node {
        min-width: 100px;
        padding-inline: 10px;
      }
    }
  </style>
</head>
<body>
  <div id="headerInclude"></div>
  <main class="container my-4">
    <div class="app-hero fade-in">
      <div>
        <h1 class="h4">Bill of Material (BOM)</h1>
        <p class="helper">Instruksi: masukkan data sesuai format. Contoh data sudah terisi sebagai placeholder.</p>
      </div>
      <div class="text-end">
        <span class="badge-accent">GenZ UI</span>
      </div>
    </div>
    <div class="card-glass fade-in">

    <div class="mb-3">
      <label for="productName" class="form-label">Nama Produk Utama:</label>
      <input type="text" id="productName" class="form-control" placeholder="Contoh: Laptop" value="Laptop">
    </div>

    <div class="mb-3">
      <label for="productQty" class="form-label">Jumlah Produksi:</label>
      <input type="number" id="productQty" class="form-control" min="1" value="5">
    </div>

    <div class="mb-3">
      <label for="inputArea" class="form-label">Bill of Materials / 1 Unit Produk Utama</label>
      <textarea id="inputArea" class="form-control" rows="8" aria-label="Input area" placeholder="Laptop: Motherboard*1, RAM*2, SSD*1, Casing*1, Keyboard*1, Touchpad*1&#10;Motherboard: CPU*1, Chipset*1, Kapasitor*10&#10;RAM: Memory Chip*8, PCB*1&#10;SSD: Flash Memory*1, Controller*1, Housing*1">Laptop: Motherboard*1, RAM*2, SSD*1, Casing*1, Keyboard*1, Touchpad*1
Motherboard: CPU*1, Chipset*1, Kapasitor*10
RAM: Memory Chip*8, PCB*1
SSD: Flash Memory*1, Controller*1, Housing*1</textarea>
      <div class="form-text input-error text-danger"></div>
    </div>

    <div class="mb-3 d-flex flex-wrap gap-2">
      <button id="btnCalc" class="btn btn-neon pulse">Hitung Kebutuhan Material</button>
      <button id="btnReset" class="btn btn-muted">Reset</button>
      <a href="index.html" class="btn btn-link" style="color:var(--muted)">Kembali ke Dashboard</a>
    </div>

    <div id="loading" style="display:none;" class="mb-3"><div class="spinner-border" role="status"><span class="visually-hidden">Memuat...</span></div> Memproses...</div>

    <section id="resultSection" style="display:none;" aria-live="polite">
      <div id="headerInfo" style="background:rgba(148,163,184,0.1); padding:12px; border-radius:8px; margin-bottom:20px; border-left:4px solid rgba(56,189,248,0.8);"></div>
      
      <h5>Kebutuhan Material</h5>
      <div id="tableArea" class="result-table"></div>

      <h5 class="mt-4">Struktur BOM (Hierarchical)</h5>
      <div id="treeArea" class="bom-tree"></div>

      <h5 class="mt-4">Chart Perbandingan Kebutuhan</h5>
      <div class="chart-wrap mt-2"><canvas id="chartArea" height="100"></canvas></div>
    </section>
    </div>
    <div class="decor-circle decor-a"></div>
    <div class="decor-circle decor-b"></div>
  </main>
  <div id="footerInclude"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/app.js"></script>
  <script>
  // include header/footer
  ['header.html','footer.html'].forEach(function(file){
    fetch(file).then(function(r){return r.text();}).then(function(t){
      if(file==='header.html') document.getElementById('headerInclude').innerHTML = t;
      else document.getElementById('footerInclude').innerHTML = t;
    });
  });

  const productName = document.getElementById('productName');
  const productQty = document.getElementById('productQty');
  const inputArea = document.getElementById('inputArea');
  const btnCalc = document.getElementById('btnCalc');
  const btnReset = document.getElementById('btnReset');
  const headerInfo = document.getElementById('headerInfo');
  const tableArea = document.getElementById('tableArea');
  const treeArea = document.getElementById('treeArea');
  const resultSection = document.getElementById('resultSection');
  const chartCtx = document.getElementById('chartArea').getContext('2d');
  let pageChart = null;

  function hitungBOM() {
    const prodName = productName.value.trim() || 'Produk';
    const prodQty = parseInt(productQty.value, 10);
    const rawStruct = inputArea.value.trim();

    if (!rawStruct || isNaN(prodQty) || prodQty <= 0) {
      alert('Masukkan struktur BOM dan jumlah produksi yang valid.');
      return;
    }

    // === PARSE STRUKTUR ===
    const lines = rawStruct.split('\n').map(x => x.trim()).filter(x => x);
    const childrenMap = {};
    const qtyPerParentMap = {};
    const allNodes = new Set();

    lines.forEach(line => {
      const parts = line.split(':');
      if (parts.length < 2) return;
      const parent = parts[0].trim();
      const rhs = parts[1].trim();
      if (!parent || !rhs) return;

      allNodes.add(parent);
      const childSpecs = rhs.split(',').map(x => x.trim()).filter(x => x);
      childSpecs.forEach(spec => {
        const cp = spec.split('*');
        const childName = cp[0].trim();
        const qty = cp[1] ? parseFloat(cp[1]) : 1;
        if (!childName || isNaN(qty) || qty <= 0) return;

        allNodes.add(childName);
        if (!childrenMap[parent]) childrenMap[parent] = [];
        childrenMap[parent].push({ name: childName, qtyPerParent: qty });
        qtyPerParentMap[parent + '||' + childName] = qty;
      });
    });

    if (!childrenMap[prodName]) {
      alert('Produk utama belum memiliki baris parent di struktur BOM.');
      return;
    }

    // === TRAVERSAL & AKUMULASI ===
    const totals = {};
    const steps = [];

    function accumulate(name, qtyNeeded, path) {
      const currentPath = path.concat(name);
      totals[name] = (totals[name] || 0) + qtyNeeded;

      const children = childrenMap[name] || [];
      if (!children.length) return;

      children.forEach(child => {
        const childTotal = qtyNeeded * child.qtyPerParent;
        const pathText = currentPath.join(' → ') + ' → ' + child.name;
        const stepText = 'Jalur ' + pathText + ': total = ' + qtyNeeded + ' × ' + child.qtyPerParent + ' = ' + childTotal;
        steps.push(stepText);

        accumulate(child.name, childTotal, currentPath);
      });
    }

    accumulate(prodName, prodQty, []);

    // === HEADER INFO ===
    headerInfo.innerHTML = '<strong>Untuk membuat <span style="color:rgba(56,189,248,1); font-size:1.1em;">' + prodQty + ' unit ' + prodName + '</span>, dibutuhkan:</strong>';

    // === TABEL HASIL ===
    const names = Object.keys(totals);
    names.sort((a, b) => {
      if (a === prodName) return -1;
      if (b === prodName) return 1;
      return a.localeCompare(b);
    });

    let tableHtml = '<table class="table table-sm">';
    tableHtml += '<thead><tr><th>Item</th><th>Total Kebutuhan</th></tr></thead>';
    tableHtml += '<tbody>';

    names.forEach(name => {
      const totalForLot = totals[name];

      tableHtml += '<tr><td>' + name + '</td><td><strong>' + totalForLot + '</strong></td></tr>';
    });

    tableHtml += '</tbody></table>';
    tableArea.innerHTML = tableHtml;

    // === TREE VISUALIZATION ===
    function renderNode(name, parent) {
      const children = childrenMap[name] || [];
      const isRoot = parent === null;
      const totalQty = totals[name] || 0;
      const perParent = parent ? (qtyPerParentMap[parent + '||' + name] || null) : null;

      let html = '<div class="bom-tree-branch">';
      html += '<div class="bom-node' + (isRoot ? ' bom-node-root' : '') + '">';
      html += '<div class="bom-node-title">' + name + '</div>';
      html += '<div class="bom-node-qty">';
      if (perParent) html += perParent + 'x/parent · ';
      html += totalQty + 'x total';
      html += '</div></div>';

      if (children.length) {
        html += '<div class="bom-tree-children">';
        children.forEach(child => {
          html += renderNode(child.name, name);
        });
        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    treeArea.innerHTML = renderNode(prodName, null);

    // === CHART ===
    const chartLabels = [];
    const chartTotals = [];
    names.forEach(name => {
      if (name === prodName) return;
      chartLabels.push(name);
      chartTotals.push(totals[name]);
    });

    if (pageChart) pageChart.destroy();
    pageChart = new Chart(chartCtx, {
      type: 'bar',
      data: {
        labels: chartLabels,
        datasets: [{
          label: 'Kebutuhan Total Komponen',
          data: chartTotals,
          backgroundColor: 'rgba(54,162,235,0.6)',
          borderColor: 'rgba(54,162,235,1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });

    resultSection.style.display = 'block';
  }

  btnCalc.addEventListener('click', hitungBOM);

  btnReset.addEventListener('click', function(){
    productName.value = 'Laptop';
    productQty.value = '5';
    inputArea.value = 'Laptop: Motherboard*1, RAM*2, SSD*1, Casing*1, Keyboard*1, Touchpad*1\nMotherboard: CPU*1, Chipset*1, Kapasitor*10\nRAM: Memory Chip*8, PCB*1\nSSD: Flash Memory*1, Controller*1, Housing*1';
    headerInfo.innerHTML = '';
    tableArea.innerHTML = '';
    treeArea.innerHTML = '';
    resultSection.style.display = 'none';
    if(pageChart){ pageChart.destroy(); pageChart=null; }
  });
  </script>
</body>
</html>
