<!-- forecasting.html -->
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ERP - Forecasting (Trend Linear)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/css/styles.css" rel="stylesheet">
</head>
<body>
  <div id="headerInclude"></div>
  <main class="container my-4">
    <h1 class="h4">Forecasting</h1>
    <p class="text-muted">Peramalan dengan metode Trend Linear: y = a + bX (X). Masukkan data historis dipisah koma.</p>

    <div class="mb-3">
      <label for="inputArea" class="form-label">Input (format lihat contoh):</label>
      <textarea id="inputArea" class="form-control" rows="6" aria-label="Input area">120,130,125,140,150,160</textarea>
      <div class="form-text input-error text-danger"></div>
    </div>

    <div class="mb-3">
      <button id="btnCalc" class="btn btn-primary">Hitung</button>
      <button id="btnReset" class="btn btn-secondary">Reset</button>
      <button id="btnCSV" class="btn btn-outline-success">Export CSV</button>
      <a href="index.html" class="btn btn-link">Kembali ke Dashboard</a>
    </div>

    <div id="loading" style="display:none;" class="mb-3"><div class="spinner-border" role="status"><span class="visually-hidden">Memuat...</span></div> Memproses...</div>

    <section id="resultSection" aria-live="polite">
      <h5 class="mt-3">Tabel Perhitungan</h5>
      <div id="tableArea" class="result-table"></div>
      
      <h5>Langkah Perhitungan</h5>
      <div id="stepsArea" class="accordion"></div>

      <h5 class="mt-3">Chart</h5>
      <canvas id="chartArea" height="100"></canvas>
    </section>
  </main>
  <div id="footerInclude"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/app.js"></script>
  <script>
  // include header/footer
  ['header.html','footer.html'].forEach(function(file){
    fetch(file).then(function(r){return r.text();}).then(function(t){
      if(file==='header.html') document.getElementById('headerInclude').innerHTML = t;
      else document.getElementById('footerInclude').innerHTML = t;
    });
  });

  const inputArea = document.getElementById('inputArea');
  const extra = document.getElementById('extra');
  const btnCalc = document.getElementById('btnCalc');
  const btnReset = document.getElementById('btnReset');
  const btnCSV = document.getElementById('btnCSV');
  const loading = document.getElementById('loading');
  const stepsArea = document.getElementById('stepsArea');
  const tableArea = document.getElementById('tableArea');
  const chartCtx = document.getElementById('chartArea').getContext('2d');
  let pageChart = null;

  function showSteps(steps){
    stepsArea.innerHTML = '';
    steps.forEach(function(s,i){
      var id = 'step'+i;
      var title = (typeof s === 'string') ? s : (s.title || ('Langkah ' + (i+1)));
      var body = (typeof s === 'string') ? '' : (s.body || '');
      var item = document.createElement('div');
      item.className = 'accordion-item';
      item.innerHTML = '<h2 class="accordion-header" id="h'+id+'">\
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#'+id+'" aria-expanded="false">'+(i+1)+'. '+title+'</button>\
      </h2>' +
      '<div id="'+id+'" class="accordion-collapse collapse"><div class="accordion-body">'+ (body || '<em>Tidak ada detail.</em>') +'</div></div>';
      stepsArea.appendChild(item);
    });
  }

  // Generate X terkode untuk Trend Linear
  function generateCodedX(n){
    const xs = [];
    if(n % 2 === 1){
      const half = (n - 1) / 2;
      for(let k=-half; k<=half; k++) xs.push(k);
    } else {
      const half = n / 2;
      for(let i=half-1; i>=0; i--) xs.push(-(2*i+1));
      for(let i=0; i<half; i++) xs.push(2*i+1);
    }
    return xs;
  }

  function buildTrendLinearDetails(y){
    const n = y.length;
    const x = generateCodedX(n);
    const sumY = y.reduce((a,b)=>a+b,0);
    let sumXY = 0, sumX2 = 0;
    for(let i=0;i<n;i++){ sumXY += x[i]*y[i]; sumX2 += x[i]*x[i]; }
    const a = sumY / n;
    const b = sumXY / sumX2;
    const stepVal = x[n-1] - x[n-2];
    const nextX = x[n-1] + stepVal;
    const yPred = a + b * nextX;

    const steps = [];
    steps.push({
      title: '1. Penentuan X terkode',
      body: '<div class="alert alert-info mb-2"><strong>Aturan:</strong></div>'+
            '<div>- n ganjil: X simetris dari 0 (mis. n=5 → -2,-1,0,1,2)</div>'+
            '<div>- n genap: bilangan ganjil simetris tanpa 0 (mis. n=8 → -7,-5,-3,-1,1,3,5,7)</div>'+
            '<div class="mt-2">X terkode: <strong>'+x.join(', ')+'</strong></div>'
    });
    steps.push({
      title: '2. Hitung a',
      body: 'a = Σy / n = '+sumY.toFixed(2)+' / '+n+' = <strong>'+a.toFixed(4)+'</strong>'
    });
    steps.push({
      title: '3. Hitung b',
      body: 'b = Σ(x·y) / Σ(x²) = '+sumXY.toFixed(2)+' / '+sumX2.toFixed(2)+' = <strong>'+b.toFixed(4)+'</strong>'
    });
    steps.push({
      title: '4. Garis trend',
      body: 'y = a + bX = '+a.toFixed(4)+' + ('+b.toFixed(4)+' × X)'
    });
    steps.push({
      title: '5. Prediksi periode berikutnya',
      body: 'X baru = '+x[n-1]+' + (step = '+stepVal+') = <strong>'+nextX+'</strong><br>'+
            'y baru = a + b·X baru = '+a.toFixed(4)+' + ('+b.toFixed(4)+' × '+nextX+') = <strong>'+yPred.toFixed(2)+'</strong>'
    });

    return {steps, table: {x, y, sumY, sumXY, sumX2}, params: {a,b,nextX,yPred}};
  }

  btnCalc.addEventListener('click', function(){
    const raw = inputArea.value.trim();
    APP.clearError(inputArea);
    if(!raw){ APP.showError(inputArea, 'Masukkan data historis terlebih dahulu.'); return; }
    const y = raw.split(',').map(s=>Number(s.trim())).filter(v=>!isNaN(v));
    if(y.length < 2){ APP.showError(inputArea, 'Minimal diperlukan 2 data.'); return; }
    loading.style.display='inline-block';
    setTimeout(function(){
      loading.style.display='none';
      // Build steps and params
      const {steps, table, params} = buildTrendLinearDetails(y);
      showSteps(steps);

      // Build table X, Y, XY, X^2 with totals
      const n = y.length;
      const rowsHtml = [];
      let sumXY = 0, sumX2 = 0, sumX = 0;
      for(let i=0;i<n;i++){
        const xi = table.x[i];
        const yi = y[i];
        const xy = xi * yi;
        const x2 = xi * xi;
        sumXY += xy; sumX2 += x2; sumX += xi;
        rowsHtml.push('<tr>'+
          '<td>'+(i+1)+'</td>'+
          '<td>'+xi+'</td>'+
          '<td>'+yi+'</td>'+
          '<td>'+xy.toFixed(2)+'</td>'+
          '<td>'+x2.toFixed(2)+'</td>'+
        '</tr>');
      }
      const tableHtml = '<div class="table-responsive">'+
        '<table class="table table-sm table-bordered">'+
        '<thead><tr><th>Periode</th><th>X</th><th>Y</th><th>X·Y</th><th>X²</th></tr></thead>'+
        '<tbody>'+rowsHtml.join('')+
        '<tr><th>Σ</th><th>'+sumX+'</th><th>'+table.sumY.toFixed(2)+'</th><th>'+sumXY.toFixed(2)+'</th><th>'+sumX2.toFixed(2)+'</th></tr>'+
        '</tbody></table></div>';
      tableArea.innerHTML = tableHtml;

      // Chart: actual vs trend line (include next period)
      const x = table.x;
      const a = params.a; const b = params.b;
      const nextLabel = 'Periode ' + (y.length+1);
      const labels = Array.from({length:y.length}, (_,i)=> 'Periode '+(i+1)).concat([nextLabel]);
      const trendY = x.map((xi,i)=> a + b*xi).concat([params.yPred]);
      const actual = y.concat([null]);
      pageChart = APP.renderChart(
        chartCtx,
        'line',
        labels,
        [
          {label:'Data Aktual', data: actual, borderColor:'rgba(220,53,69,1)', backgroundColor:'rgba(220,53,69,0.15)', borderWidth: 2, pointBackgroundColor:'rgba(220,53,69,1)', pointRadius: 4, spanGaps:false, tension:0.2},
          {label:'Garis Trend', data: trendY, borderColor:'rgba(13,110,253,1)', backgroundColor:'rgba(13,110,253,0.1)', borderWidth: 2, borderDash:[6,4], pointRadius: 0, spanGaps:true, tension:0.2}
        ],
        pageChart
      );
    }, 400);
  });

  btnReset.addEventListener('click', function(){
    inputArea.value = "120,130,125,140,150,160";
    extra.value = '';
    stepsArea.innerHTML = '';
    tableArea.innerHTML = '';
    if(pageChart){ pageChart.destroy(); pageChart=null; }
  });

  btnCSV.addEventListener('click', function(){
    var table = tableArea.querySelector('table');
    if(!table){ alert('Tidak ada tabel untuk diexport'); return; }
    var rows = Array.from(table.querySelectorAll('tr')).map(function(tr){ return Array.from(tr.querySelectorAll('th,td')).map(function(td){ return td.textContent; }); });
    APP.exportCSV("forecastingresult.csv", rows);
  });
  </script>
</body>
</html>
